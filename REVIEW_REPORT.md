# A) Severity-ordered findings (P0/P1/P2/P3)

## P1 — Unverified `rg_mbid_hint` can produce false-positive normalization (wrong album IDs)
- **Severity:** P1
- **Impact:** Candidate normalization can mark a release-group MBID as valid with confidence `1.0` even when the MB lookup fails. This can leak invalid/stale MBIDs into scoring, constraints, and output JSON.
- **Reproduction scenario:** Simulate a ListenBrainz candidate with `rg_mbid_hint="deadbeef..."` where `musicbrainz_get_release_group(...)` returns `None`. `_normalize_candidate` still returns `NormalizedCandidate(mb_release_group_id=c.rg_mbid_hint, confidence=1.0, source="hint:rg_mbid")`.
- **Location:** `daily3albums/dry_run.py::_normalize_candidate`.
- **Evidence:** In the `if c.rg_mbid_hint:` branch, the code always returns a normalized object, even when `rg` is `None`.
- **Fix sketch:** Only accept `rg_mbid_hint` when lookup confirms the RG exists; otherwise fall through to text search (or return `None` with reason `hint_not_resolved`). Keep confidence conservative for hint-based paths.

## P1 — UI build subprocess has no timeout (bounded termination gap)
- **Severity:** P1
- **Impact:** `daily3albums build` can hang indefinitely in CI or local runs if `npm run build` stalls (node process deadlock, network stall in tooling, etc.). This violates bounded-time termination goals.
- **Reproduction scenario:** Run `daily3albums build` in an environment where npm script never exits (e.g., custom script with infinite wait). Process does not enforce a maximum duration.
- **Location:** `daily3albums/cli.py::cmd_build`.
- **Evidence:** `subprocess.run([...], check=False, cwd=repo_root)` is called without `timeout=`.
- **Fix sketch:** Add configurable timeout (e.g., `build.ui_timeout_s`) and surface structured diagnostics on timeout (`BUILD ERROR: ui build timeout`, elapsed time, command).

## P2 — `mb_queries_attempted_total` diagnostics undercount MB work
- **Severity:** P2
- **Impact:** MB diagnostics can mislead operators; query counters often stay `0` for MBID/hint paths even when MB requests were actually made.
- **Reproduction scenario:** Candidate with `lastfm_mbid` or `rg_mbid_hint` enters `_normalize_candidate`; MB requests happen via direct lookup helpers, but `mb_queries_attempted` is extracted only from debug strings (`search:queries_attempted=`) generated by text-search path.
- **Location:** `daily3albums/dry_run.py::_normalize_candidate`, `daily3albums/dry_run.py::run_dry_run`.
- **Evidence:** Counter extraction relies on parsing debug lines; MBID/hint branches return without incrementing this metric.
- **Fix sketch:** Return structured counters from each normalization branch (e.g., `mb_http_calls`, `mb_search_queries`), aggregate explicitly in `run_dry_run`, and keep old key for backward compatibility.

## P3 — `pages_planned` semantics are approximate and can mislead progress views
- **Severity:** P3
- **Impact:** Slot progress may overstate/understate planned work because planned pages are computed from tag-count * max-pages, while actual control flow includes cooldown skips and dual fetch limits.
- **Reproduction scenario:** Theme cooldown skips many tags; `pages_planned` remains high even though those tags were never fetched.
- **Location:** `daily3albums/cli.py::cmd_build` slot diagnostics.
- **Fix sketch:** Report separate fields: `tags_considered`, `tags_skipped_cooldown`, `fetch_windows_attempted`, `lastfm_pages_planned_effective`.

# B) Boundedness audit table

| Location | What it bounds | Cap/budget source | Failure behavior | Gap |
|---|---|---|---|---|
| `cli.py::cmd_build` `for slot_id in range(3)` | slots/day | hard-coded 3 | abort build on slot exhaustion | none |
| `cli.py::cmd_build` tag attempts | theme/tag retries per slot | `cfg.max_tag_tries_per_slot` default 8 | if not enough picks, return exit 2 | none |
| `cli.py::cmd_build` fetch windows per tag | candidate expansion tries | fixed tuple `(max(n,200), 400)` | switch fetch window or next tag | none |
| `dry_run.py::run_dry_run` Last.fm pages | Last.fm page fanout | `lastfm_page_start + lastfm_max_pages` plus hard cap 1000 | stop at computed page list | none |
| `dry_run.py::run_dry_run` Discogs pages | Discogs page reach | config + hard cap 100 and adapter max_pages | clamp page; continue | none |
| `dry_run.py::run_dry_run` ListenBrainz metadata batching | metadata request count | chunk size 25 over finite MBID list | continues; broad exception swallow | weak observability only |
| `dry_run.py::run_dry_run` heavy normalization candidates | MB normalize workload | `mb_max_candidates_per_slot` | sets `mb_cap_hit=True`, breaks loop | none |
| `dry_run.py::run_dry_run` per-slot MB time | MB normalization wall time | `mb_time_budget_s_per_slot` | sets `mb_budget_exceeded=True`, breaks loop | none |
| `adapters.py::musicbrainz_best_release_group_match_debug` MB search attempts/candidate | text-search query count | `max_queries_per_candidate` | sets `query_cap_hit`, stops query loop | none |
| `request_broker.py::RequestBroker.get` retry loop | HTTP retries per request | adapter policy `max_attempts` | raises `RequestFailed` / `BrokerRequestError` | bounded |
| `request_broker.py::_rate_limit` host pacing | per-host request spacing | `rate_limit_rps` | sleeps once/request, then proceeds | bounded |
| `cli.py::cmd_build` UI build subprocess | frontend build duration | **none currently** | may hang indefinitely | **termination gap** |

# C) Diagnostics quality audit

- `mb_candidates_considered`, `mb_candidates_normalized`, `mb_budget_exceeded`, `mb_cap_hit`, `mb_time_spent_s` are semantically consistent with the normalization loop and are useful.
- `mb_queries_attempted_total` is **misleading** because it tracks parsed search debug markers, not total MB HTTP activity (MBID and hint paths undercount).
  - **Proposal:** add `mb_http_calls_total` and `mb_search_queries_total`; keep legacy key with deprecation note.
- Discogs diagnostics are reasonably actionable (`discogs_failed_status`, `discogs_cached_negative_used`, `discogs_page_cap_hit`).
- Broker-level stats (`requests/timeouts/retries/status_X`) are useful, but currently adapter diagnostics and per-slot diagnostics are not fully reconciled into one run-end summary object.
- Ctrl+C diagnostics print adapter stats and slot progress; this is good, but failure summaries for non-interrupt exits should mirror this shape for consistency.

# D) Test gaps + proposed tests

1. **Hint validation correctness test (high impact):**
   - Given `rg_mbid_hint` where MB lookup returns `None`, assert normalization does **not** return confidence-1.0 normalized candidate.
2. **UI build timeout test:**
   - Mock `subprocess.run` to block/raise timeout and assert bounded non-zero exit with structured diagnostics.
3. **MB diagnostics semantics test:**
   - Verify `mb_queries_attempted_total` (or replacement counters) reflect MBID-path calls and text-search-path calls distinctly.
4. **Broker retry matrix test (4xx/5xx/timeout):**
   - Validate no retry for fatal 4xx, non-fatal empty for Discogs 404, retry for 429/5xx/timeouts within cap.
5. **Schema compatibility test (today + archive):**
   - Validate required fields and optional/null handling align with `ui/src/lib/types.ts` parser expectations.
6. **Ctrl+C behavior integration test:**
   - Simulate `KeyboardInterrupt` in build and dry-run paths; assert exit code 130 and diagnostics payload presence.

# E) Minimal-change PR plan (3–7 commits)

1. **Commit 1 — Fix hint-path normalization correctness**
   - Gate `rg_mbid_hint` acceptance on successful MB lookup; downgrade/fallback when unresolved.
2. **Commit 2 — Add UI build timeout + diagnostics**
   - Add configurable `ui_build_timeout_s`; enforce in `subprocess.run(timeout=...)` and print structured error.
3. **Commit 3 — Correct MB diagnostics counters**
   - Return structured counters from normalization helpers and aggregate truthful totals.
4. **Commit 4 — Tighten progress diagnostics semantics**
   - Split planned/effective counters for pages/tags/fetch windows.
5. **Commit 5 — Add targeted tests**
   - Add tests for (1) hint invalidation, (2) timeout handling, (3) diagnostics counters, (4) retry matrix.
